/////SWARM CHARGE//////////////////////////////////////////////////////////////
//Actor SwarmChargeEquipped : Inventory {inventory.maxamount 1}
//Actor PickedUpSwarmCharge : Inventory {inventory.maxamount 1}
//Actor PrepSwarmCharge : Inventory {inventory.maxamount 1}
Actor RemoteChargeDetonator : Inventory { inventory.maxamount 1 }
Actor SwarmDroneLifetime : Inventory {inventory.maxamount 30}

Actor WW_SwarmerSelected : inventory{}

//the token pb sets as "actually using this equipment"
Actor SwarmerSelected : inventory{}

//this is just ammo for the equipment itself
Actor SwarmerAmmo : ammo
{
	Inventory.Amount 1
	Inventory.MaxAmount 2
	Ammo.BackPackAmount 1
	Ammo.BackPackMaxAmount 3
	Inventory.PickUpMessage ""
	Inventory.Icon SWRMR0
	+INVENTORY.IGNORESKILL
	Scale 0.45
}

ACTOR SwarmCharge: CustomInventory {
	Game Doom
	Scale 0.45
	+DONTGIB
	+FLOORCLIP
	Inventory.PickupMessage "Swarm Charge (Remote Bomb)"
	Inventory.PickupSound "Ammocase/Open"
	States {
		Spawn:
			SWRM R 1 A_SpawnItem("OrangeFlareSmall",-1,1)
			Loop
		Pickup:
			//TNT1 A 0 A_TakeInventory("MineAmmo",1) 
			//TNT1 A 0 A_TakeInventory("LaserChargeAmmo",1) 
			TNT1 A 0 A_GiveInventory("SwarmerAmmo",1)   
			TNT1 A 0 A_GiveInventory("DetonatorAmmo",1)
			//TNT1 A 0 A_TakeInventory("PickedUpRemoteCharge",1) 
			//TNT1 A 0 A_TakeInventory("PickedUpLaserCharge",1) 
			//TNT1 A 0 A_GiveInventory("PickedUpSwarmCharge",1)
			//TNT1 A 0 A_GiveInventory("PrepSwarmCharge",1) 
			//TNT1 A 0 A_GiveInventory("CycleEquipment",1)
			TNT1 A 20
			Stop	}}
			
ACTOR ThrownSwarmCharge : SwitchableDecoration{	
	Radius 5
	Height 5
	speed 24
	Damage 0
	Health 2
	DamageType Explosive
    +MISSILE
	+LOOKALLAROUND
	+QUICKTORETALIATE
	+USESPECIAL
	+NOBLOOD
	-EXPLODEONWATER
	-NOEXTREMEDEATH
    +BLOODSPLATTER
	+EXTREMEDEATH
	+FORCEXYBILLBOARD
	+CANBOUNCEWATER
	+DONTBOUNCEONSHOOTABLES
	+USEBOUNCESTATE
	+BOUNCEONWALLS
	+BOUNCEONFLOORS
	+BOUNCEONCEILINGS
	+MOVEWITHSECTOR
	+DONTSPLASH
	+HITTRACER
	Bouncetype "Doom"
	BounceFactor 0.0
	BounceCount 300
	Scale .45
    Gravity 0.7
    Decal "Scorch"
    SeeSound "weapon/grenade"
	BounceSound "weapon/grenade"
	DeathSound "Explosion"
	Obituary "$OB_MPROCKET"
	Damagetype ExplosiveImpact
	DeathSound ""
	damagefactor "Kick", 0
	damagefactor "ExtremePunches", 0
	damagefactor "Melee", 0
	damagefactor "Trample", 0
	Activation THINGSPEC_Activate | THINGSPEC_ThingTargets | THINGSPEC_NoDeathSpecial
	var int user_stickycounter;
	var int user_stuckEnemy;
	States
	{
		Spawn:
			TNT1 A 0 {
				if(waterlevel > 1) {A_SpawnItem ("RocketSmokeTrail52"); }
				A_SpawnItemEx ("OrangeFlareSmall",0,0,0,0,0,0,0,SXF_NOCHECKPOSITION,0);
			}
			SWRM S 1 Bright A_JumpIfInventory("RemoteChargeDetonator",1,"Death",AAPTR_TARGET) 
			Loop
			
			/*
			TNT1 A 0
			SWRM S 10
			TNT1 A 0 A_ChangeFlag ("SHOOTABLE",1)
			//TNT1 A 0 A_JumpIf(waterlevel > 1, "Death")
			SWRM S 1 Bright A_JumpIfInventory("RemoteChargeDetonator",1,"Death",AAPTR_TARGET)
			SWRM SSS 8 A_LookEx(LOF_NOSOUNDCHECK,0,160,0,0,"Death")
			TNT1 A 0 A_PlaySound ("Weapons/StickyBombTick")
			TNT1 A 0 A_SpawnItem ("OrangeFlareSmall",0,6)
			SWRM S 1 A_LookEx(LOF_NOSOUNDCHECK,0,160,0,0,"Death")
			TNT1 A 0 A_SpawnItem ("OrangeFlareSmall",0,6)
			SWRM S 1 A_LookEx(LOF_NOSOUNDCHECK,0,160,0,0,"Death")
			TNT1 A 0 A_SpawnItem ("OrangeFlareSmall",0,6)
			SWRM S 1 A_LookEx(LOF_NOSOUNDCHECK,0,160,0,0,"Death")
			TNT1 A 0 A_SpawnItem ("OrangeFlareSmall",0,6)
			SWRM S 1 A_LookEx(LOF_NOSOUNDCHECK,0,160,0,0,"Death")
			TNT1 A 0 A_SpawnItem ("OrangeFlareSmall",0,6)
			SWRM S 1 A_LookEx(LOF_NOSOUNDCHECK,0,160,0,0,"Death")
			TNT1 A 0 A_SpawnItem ("OrangeFlareSmall",0,6)
			SWRM S 1 A_LookEx(LOF_NOSOUNDCHECK,0,160,0,0,"Death")
			TNT1 A 0 A_SpawnItem ("OrangeFlareSmall",0,6)
			SWRM S 1 A_LookEx(LOF_NOSOUNDCHECK,0,160,0,0,"Death")
			TNT1 A 0 A_SpawnItem ("OrangeFlareSmall",0,6)
			SWRM S 1 A_LookEx(LOF_NOSOUNDCHECK,0,160,0,0,"Death")
			Goto Spawn+3
			*/
			
		Active:
			TNT1 A 0 A_PlaySound ("charge/beep/swarm")
			TNT1 A 0 A_SpawnItemEx ("OrangeFlareSmall",0,0,0,0,0,0,0,SXF_NOCHECKPOSITION,0)
			SWRM S 6 Bright
			TNT1 A 0 A_PlaySound ("charge/beep/swarm")
			TNT1 A 0 A_SpawnItemEx ("OrangeFlareSmall",0,0,0,0,0,0,0,SXF_NOCHECKPOSITION,0)
			SWRM S 6 Bright
			TNT1 A 0 A_PlaySound ("charge/beep/swarm")
			TNT1 A 0 A_SpawnItemEx ("OrangeFlareSmall",0,0,0,0,0,0,0,SXF_NOCHECKPOSITION,0)
			SWRM S 6 Bright
			SWRM S 4 
			TNT1 A 0 A_NoBlocking
			TNT1 A 0 A_ChangeFLag ("SHOOTABLE", 0)
			//TNT1 A 0 A_GiveToTarget("GrabbedObject", 1)
			//TNT1 A 0 A_TakeFromTarget("MineAmmo",1) 
			//TNT1 A 0 A_TakeFromTarget("LaserChargeAmmo",1)
			TNT1 A 0 A_SpawnItemEx ("SwarmCharge",0,0,0,0,0,0,0,SXF_NOCHECKPOSITION,0)
			//TNT1 A 0 A_GiveToTarget("SwarmerAmmo",1)   
			//TNT1 A 0 A_TakeFromTarget("PickedUpRemoteCharge",1) 
			//TNT1 A 0 A_TakeFromTarget("PickedUpLaserCharge",1) 
			//TNT1 A 0 A_GiveToTarget("PickedUpSwarmCharge",1)
			//TNT1 A 0 A_GiveToTarget("PrepSwarmCharge",1) 
			//TNT1 A 0 A_GiveToTarget("CycleEquipment",1)
			TNT1 A 0
			Stop	
		Bounce:
			TNT1 A 0 {
				user_stickycounter = 0;
				A_NoGravity;
				A_ScaleVelocity(0);
				A_ChangeFlag("NOBLOCKMAP",0);
				A_ChangeFlag("SHOOTABLE",1);
			}
		Stuck:
			SWRM SSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS 1 BRIGHT {
				//A_Fire(22);
				if(user_stuckEnemy == 1) {

					if(AAPTR_TRACER) {
						A_Warp(AAPTR_TRACER,0,0,20,0,WARPF_NOCHECKPOSITION);
					}
					else {
						A_Fall;
					}
				}
				if(CountInv("RemoteChargeDetonator", AAPTR_TARGET) == 1) {
					return state("Death");
				}
				return state("");
			}
			TNT1 A 0 {
				A_SpawnItem("RedFlareSmall",0,0);
				A_PlaySound("charge/beep/swarm", 4);
				user_stickycounter++;
			}
			TNT1 A 0 A_JumpIf(user_stickycounter < 10, "Stuck")
			TNT1 A 0 A_JumpIf(user_stickycounter > 10, "Death")
			Loop
		XDeath:
		Bounce.Creature:
			SWRM S 1 {
				A_Changeflag("THRUACTORS", 1);
				A_Changeflag("Solid", 1);
				user_stuckEnemy = 1;
				A_Stop;
			}
			SWRM S 1 {
				A_Changeflag("THRUACTORS", 0);
				A_Changeflag("Solid", 0);
			}
			Goto Stuck
		Death:
			TNT1 A 0 A_ChangeFlag ("NOCLIP", 1)
			TNT1 A 0 A_Changeflag("NOBLOCKMAP", 1)
			TNT1 A 0 A_Changeflag("SOLID", 0)
			TNT1 A 0 A_ChangeFlag ("FLOORCLIP", 0)
			TNT1 A 0 A_Changeflag("THRUACTORS", 1)
			TNT1 A 0 A_PlaySound("charge/activate/swarm")
			SWRM S 10 BRIGHT
			TNT1 A 0 A_Stop
			TNT1 A 0 A_StopSound(6)
			TNT1 A 0 A_PlaysoundEx("SwarmDrone/WindUp","Auto")
			TNT1 A 0 A_PlaysoundEx("Charge/Detonate/Swarm","Auto")
			TNT1 A 0 A_SpawnItem("WhiteShockwave")
			TNT1 A 0 A_SpawnItemEx ("DetectFloorCrater",0,0,0,0,0,0,0,SXF_NOCHECKPOSITION,0)
			TNT1 A 0 A_SpawnItemEx ("DetectCeilCrater",0,0,0,0,0,0,0,SXF_NOCHECKPOSITION,0)
			TNT1 A 0 A_SpawnItemEx ("NewGroundExplosionSmoke",0,0,0,0,0,0,0,SXF_NOCHECKPOSITION,0)
			EXPL A 0 Radius_Quake (2, 24, 0, 15, 0)
			BEXP B 0 BRIGHT A_Scream
			TNT1 A 0 A_ALertMonsters
			TNT1 A 0 A_SpawnItem("BarrelExplosionSmokeColumn")
			TNT1 A 0 A_SpawnItem("FragGrenadeExplosionSmoke")
			TNT1 AAAAA 1 {
				A_SpawnItemEx ("SwarmDrone",0,0,3,random(-5,5),random(-5,5),random(1,5),0,SXF_NOCHECKPOSITION,0);
				A_SpawnItemEx ("SwarmDrone",0,0,3,random(-5,5),random(-5,5),random(1,5),0,SXF_NOCHECKPOSITION,0);
				A_SpawnItemEx ("SwarmDrone",0,0,3,random(-5,5),random(-5,5),random(1,5),0,SXF_NOCHECKPOSITION,0);
				A_SpawnItemEx ("SwarmDrone",0,0,3,random(-5,5),random(-5,5),random(1,5),0,SXF_NOCHECKPOSITION,0);
				A_SpawnItemEx ("SwarmDrone",0,0,3,random(-5,5),random(-5,5),random(1,5),0,SXF_NOCHECKPOSITION,0);
				A_SpawnItemEx ("SwarmDrone",0,0,3,random(-5,5),random(-5,5),random(1,5),0,SXF_NOCHECKPOSITION,0);
				A_SpawnItemEx ("SwarmDrone",0,0,3,random(-5,5),random(-5,5),random(1,5),0,SXF_NOCHECKPOSITION,0);
				A_SpawnItemEx ("SwarmDrone",0,0,3,random(-5,5),random(-5,5),random(1,5),0,SXF_NOCHECKPOSITION,0);
				A_SpawnItemEx ("SwarmDrone",0,0,3,random(-5,5),random(-5,5),random(1,5),0,SXF_NOCHECKPOSITION,0);
				A_SpawnItemEx ("SwarmDrone",0,0,3,random(-5,5),random(-5,5),random(1,5),0,SXF_NOCHECKPOSITION,0);
			}
			TNT1 A 1 A_Stop
			Stop	}}
ACTOR SwarmDrone {
	Radius 3
	Height 3
	Speed 12
	Mass 10
	Scale 0.15
	Gravity 0.1
	ActiveSound "SwarmDrone/Idle"
	SeeSound "SwarmDrone/Idle"
	MeleeSound "Sawblade/Ricochet"
	DeathSound "SwarmDrone/BurnOut"
	Monster
	Species "Marines"
	+Friendly
	+BOUNCEONWALLS
	+FLOAT
	+FLOATBOB
	+THRUACTORS
	+NOTELEPORT
	-COUNTKILL
	-BLOODSPLATTER
	+NOBLOOD
	+NOGRAVITY
	+DONTHURTSPECIES
	+DONTHARMSPECIES
		States {
			Spawn:
				SPMT A 1 {
					A_Look;
					A_FaceTarget;
					A_Playsound("SwarmDrone/Idle");
				}
			Idle:
				SPMT AAAAAAAAAAAAAAA 1 A_Wander
				SPMT A 1 {
					A_Look;
					A_FaceTarget;
					A_Playsound("SwarmDrone/Idle");
					A_GiveInventory("SwarmDroneLifetime",1);
				}
				TNT1 A 0 A_JumpIfInventory("SwarmDroneLifetime",30,"Idle2")
				Loop
			Idle2:
				SPMT AAAAAAAAAAAAAAA 1 A_Wander
				SPMT A 1 {
					A_Look;
					A_FaceTarget;
					A_Playsound("SwarmDrone/Idle");
				}
				TNT1 A 0 A_Jump(164,"Idle2")
				Goto Death
			See:
				SPMT AAAAAAAAAAAAAAA 1 A_Chase
				SPMT A 1 {
					A_Chase;
					A_FaceTarget;
					A_Playsound("SwarmDrone/Idle");
					A_GiveInventory("SwarmDroneLifetime",1);
				}
				TNT1 A 0 A_JumpIfInventory("SwarmDroneLifetime",30,"Idle2")
				Loop
			Melee:
				SPMT A 1 {
					A_CustomMissile("SwarmDroneAttack",0,0,0,0);
					A_Playsoundex("Sawblade/Ricochet","Auto");
				}
				Stop
			Death:
				SPMT A 1 {
					A_Scream;
					A_Fall;
					A_Stop;
					A_Changeflag("NOGRAVITY", 0);
					A_Changeflag("FLOAT", 0);
					A_Changeflag("FLOATBOB", 0);
				}
				SPMT A 100
				SPMT AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA 1 A_FadeOut(0.02)
				Stop	}}		
ACTOR SwarmDroneAttack: FastProjectile {
	Radius 8
	Height 8
	DamageType "Cut"
	Projectile 
    Speed 15
	+RANDOMIZE
    Damage 10
    +RIPPER
	+FORCEXYBILLBOARD
	+THRUGHOST
	RenderStyle Add
	Alpha 0.6
	SeeSound "none"
	DeathSound "none"
	Decal "none"
		States {
			Spawn:
				TNT1 A 4 BRIGHT
				Stop	}}